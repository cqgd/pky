<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Peaky • Peaky</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Peaky">
<meta property="og:description" content="peaky">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Peaky</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9002</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction.html">Peaky</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Peaky</h1>
                        <h4 class="author">Chris Eijsbouts</h4>
            
            <h4 class="date">2020-09-13</h4>
      
      
      <div class="hidden name"><code>introduction.Rmd</code></div>

    </div>

    
    
<div id="purpose" class="section level2">
<h2 class="hasAnchor">
<a href="#purpose" class="anchor"></a>Purpose</h2>
<p>Peaky maps physical contacts between different regions of DNA by recognizing peaks in a Capture Hi-C (CHi-C) signal for a specific region of interest. It accounts for technical and biological noise, and subsequently finds regions around which the residual signal peaks and then decays with distance. The algorithm finds sets of regions at which peaks of varying strengths combinedly explain the normalized CHi-C signal. The probability of these regions contacting a region of interest is then quantified.</p>
</div>
<div id="input" class="section level2">
<h2 class="hasAnchor">
<a href="#input" class="anchor"></a>Input</h2>
<p>Peaky requires two input files. The first contains the raw CHi-C signal: readcounts (N, must be &gt;=1) corroborating interactions between regions of interest (baits) and their putative interaction partners (preys). The second describes the physical location of each region (fragment) in the genome. These will be referred to as the interactions file and the fragments file, respectively.</p>
<p>An example of each is included with the package and used for the analysis below:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">peaky</span>)

<span class="no">base</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>,<span class="kw">package</span><span class="kw">=</span><span class="st">"peaky"</span>)

<span class="no">interactions_file</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">base</span>,<span class="st">"/counts.tsv"</span>)
<span class="no">fragments_file</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">base</span>,<span class="st">"/fragments.bed"</span>)

<span class="no">interactions</span> <span class="kw">=</span> <span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span>(<span class="no">interactions_file</span>)
<span class="no">fragments</span> <span class="kw">=</span> <span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span>(<span class="no">fragments_file</span>)

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">interactions</span>))</pre></body></html></div>
<pre><code>##    baitID preyID N
## 1:  53559  52096 1
## 2:  53559  52107 1
## 3:  53559  52112 1
## 4:  53559  52113 1
## 5:  53559  52121 1
## 6:  53559  52125 1</code></pre>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">fragments</span>))</pre></body></html></div>
<pre><code>##    chrom chromStart chromEnd  ID
## 1:     1     566754   573939 142
## 2:     1     753009   760251 196
## 3:     1     760252   761173 197
## 4:     1     848169   850618 219
## 5:     1     874082   876091 221
## 6:     1    1040209  1043143 236</code></pre>
</div>
<div id="initial-normalization-of-counts" class="section level2">
<h2 class="hasAnchor">
<a href="#initial-normalization-of-counts" class="anchor"></a>Initial normalization of counts</h2>
<p>Peaky will initially adjust the readcounts for each pair of fragments based on the linear genomic distance between them, their lengths, and transchromosomal bait activity. The effects these characteristics have on the readcounts can vary between short and long-range interactions, and they are therefore estimated multiple times from samples of interactions spanning various ranges. The first step is thus to bin interactions based on distance using <code><a href="../reference/bin_interactions.html">bin_interactions()</a></code>:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">BI</span> <span class="kw">=</span> <span class="fu"><a href="../reference/bin_interactions.html">bin_interactions</a></span>(<span class="no">interactions</span>, <span class="no">fragments</span>, <span class="kw">bins</span><span class="kw">=</span><span class="fl">5</span>)</pre></body></html></div>
<pre><code>## 31-08-2020 17:46:03
## Calculating fragment characteristics...
## 31-08-2020 17:46:03
## Adding fragment characteristics for baits...
## 31-08-2020 17:46:03
## Adding fragment characteristics for preys...
## 31-08-2020 17:46:03
## Calculating interaction distances...
## 31-08-2020 17:46:03
## Calculating total trans-chromosomal read counts for each bait...
## 31-08-2020 17:46:03
## Modelling those as a function of bait chromosome...
## GAMLSS-RS iteration 1: Global Deviance = 363.9654 
## GAMLSS-RS iteration 2: Global Deviance = 363.9654 
## 31-08-2020 17:46:03
## Adding trans-chromosomal interactivity covariate for preys that were also baited (0 for preys not baited)...
## 31-08-2020 17:46:03
## Excluding 2 interactions that are too proximal (distance &lt; 2500 bp)...
## 31-08-2020 17:46:03
## Excluding 0 interactions that are too distal (distance &gt; Inf bp)...
## 31-08-2020 17:46:03
## Assigning 5 distance bins...
## 31-08-2020 17:46:03
## Done.</code></pre>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">BI</span>$<span class="no">bins</span>)</pre></body></html></div>
<pre><code>##    dist.bin dist.abs.min dist.abs.max interactions
## 1:        1         2907       733944         9064
## 2:        2       734021      1590586         9063
## 3:        3      1590733      2558841         9063
## 4:        4      2559052      3664236         9063
## 5:        5      3664323      4999963         9064
## 6:     &lt;NA&gt;           NA           NA        32737</code></pre>
<p>The 5 distance bins created above all contain an equal number of interactions. Note that the linear genomic distance between two fragments is not defined when they are from two different chromosomes. Transchromosomal interactions (bottom row of the table) are therefore not assigned a distance bin.</p>
<p>Models that predict readscounts under the null (i.e. in the case where an interaction is not biologically significant) can then be generated for each distance bin based on a random sample of the interactions they contain using <code><a href="../reference/model_bin.html">model_bin()</a></code>:.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">models</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/by.html">by</a></span>(<span class="no">BI</span>$<span class="no">interactions</span>, <span class="no">BI</span>$<span class="no">interactions</span>$<span class="no">dist.bin</span>, <span class="no">model_bin</span>, <span class="kw">subsample_size</span><span class="kw">=</span><span class="fl">1000</span>)</pre></body></html></div>
<pre><code>## A truncated family of distributions from NBI has been generated 
##  and saved under the names:  
##  dNBI.0tr pNBI.0tr qNBI.0tr rNBI.0tr NBI.0tr 
## The type of truncation is left 
##  and the truncation parameter is 0  
## 31-08-2020 17:46:03
## Subsampling 1000/9064 interactions for the null model regression...
## 31-08-2020 17:46:03
## Fitting with a maximum of 200 iterations...
## Using formula:
## N ~ log(abs(dist)) + b.trans_res  + p.trans_res + sqrt(b.length) + sqrt(p.length)
## GAMLSS-RS iteration 1: Global Deviance = 7819.231 
## GAMLSS-RS iteration 2: Global Deviance = 7682.029 
## GAMLSS-RS iteration 3: Global Deviance = 7617.062 
## GAMLSS-RS iteration 4: Global Deviance = 7601.235 
## GAMLSS-RS iteration 5: Global Deviance = 7599.892 
## GAMLSS-RS iteration 6: Global Deviance = 7599.832 
## 31-08-2020 17:46:04
## Converged: YES
## Iterations: 6
## 
## Coefficients:
## (Intercept)  16.3536452789791
##  log(abs(dist))  -1.07984803215965
##  b.trans_res 0.176930021316788
##  p.trans_res NA
##  sqrt(b.length)  -0.00507636060750867
##  sqrt(p.length)  0.00246852651840991
## 31-08-2020 17:46:04
## Obtaining normalized randomized quantile residuals for the full dataset...
## A truncated family of distributions from NBI has been generated 
##  and saved under the names:  
##  dNBI.0tr pNBI.0tr qNBI.0tr rNBI.0tr NBI.0tr 
## The type of truncation is left 
##  and the truncation parameter is 0  
## 31-08-2020 17:46:04
## Subsampling 1000/9063 interactions for the null model regression...
## 31-08-2020 17:46:04
## Fitting with a maximum of 200 iterations...
## Using formula:
## N ~ log(abs(dist)) + b.trans_res  + p.trans_res + sqrt(b.length) + sqrt(p.length)
## GAMLSS-RS iteration 1: Global Deviance = 4184.271 
## GAMLSS-RS iteration 2: Global Deviance = 4183.31 
## GAMLSS-RS iteration 3: Global Deviance = 4182.718 
## GAMLSS-RS iteration 4: Global Deviance = 4182.346 
## GAMLSS-RS iteration 5: Global Deviance = 4182.073 
## GAMLSS-RS iteration 6: Global Deviance = 4181.893 
## GAMLSS-RS iteration 7: Global Deviance = 4181.76 
## GAMLSS-RS iteration 8: Global Deviance = 4181.659 
## GAMLSS-RS iteration 9: Global Deviance = 4181.583 
## 31-08-2020 17:46:04
## Converged: YES
## Iterations: 9
## 
## Coefficients:
## (Intercept)  33.3015786827959
##  log(abs(dist))  -2.31547069941862
##  b.trans_res 0.533726407051653
##  p.trans_res NA
##  sqrt(b.length)  -0.00336988229979575
##  sqrt(p.length)  -0.00557528934798951
## 31-08-2020 17:46:04
## Obtaining normalized randomized quantile residuals for the full dataset...
## A truncated family of distributions from NBI has been generated 
##  and saved under the names:  
##  dNBI.0tr pNBI.0tr qNBI.0tr rNBI.0tr NBI.0tr 
## The type of truncation is left 
##  and the truncation parameter is 0  
## 31-08-2020 17:46:04
## Subsampling 1000/9063 interactions for the null model regression...
## 31-08-2020 17:46:04
## Fitting with a maximum of 200 iterations...
## Using formula:
## N ~ log(abs(dist)) + b.trans_res  + p.trans_res + sqrt(b.length) + sqrt(p.length)
## GAMLSS-RS iteration 1: Global Deviance = 2920.778 
## GAMLSS-RS iteration 2: Global Deviance = 2904.93 
## GAMLSS-RS iteration 3: Global Deviance = 2899.755 
## GAMLSS-RS iteration 4: Global Deviance = 2897.391 
## GAMLSS-RS iteration 5: Global Deviance = 2896.14 
## GAMLSS-RS iteration 6: Global Deviance = 2895.391 
## GAMLSS-RS iteration 7: Global Deviance = 2894.922 
## GAMLSS-RS iteration 8: Global Deviance = 2894.615 
## GAMLSS-RS iteration 9: Global Deviance = 2894.401 
## GAMLSS-RS iteration 10: Global Deviance = 2894.25 
## GAMLSS-RS iteration 11: Global Deviance = 2894.144 
## GAMLSS-RS iteration 12: Global Deviance = 2894.065 
## 31-08-2020 17:46:04
## Converged: YES
## Iterations: 12
## 
## Coefficients:
## (Intercept)  33.782011765923
##  log(abs(dist))  -2.30021845345867
##  b.trans_res 0.394740351809247
##  p.trans_res NA
##  sqrt(b.length)  -0.00723684538012568
##  sqrt(p.length)  -0.00136740936364696
## 31-08-2020 17:46:04
## Obtaining normalized randomized quantile residuals for the full dataset...
## A truncated family of distributions from NBI has been generated 
##  and saved under the names:  
##  dNBI.0tr pNBI.0tr qNBI.0tr rNBI.0tr NBI.0tr 
## The type of truncation is left 
##  and the truncation parameter is 0  
## 31-08-2020 17:46:04
## Subsampling 1000/9063 interactions for the null model regression...
## 31-08-2020 17:46:04
## Fitting with a maximum of 200 iterations...
## Using formula:
## N ~ log(abs(dist)) + b.trans_res  + p.trans_res + sqrt(b.length) + sqrt(p.length)
## GAMLSS-RS iteration 1: Global Deviance = 2160.945 
## GAMLSS-RS iteration 2: Global Deviance = 2148.52 
## GAMLSS-RS iteration 3: Global Deviance = 2144.311 
## GAMLSS-RS iteration 4: Global Deviance = 2142.395 
## GAMLSS-RS iteration 5: Global Deviance = 2141.369 
## GAMLSS-RS iteration 6: Global Deviance = 2140.774 
## GAMLSS-RS iteration 7: Global Deviance = 2140.403 
## GAMLSS-RS iteration 8: Global Deviance = 2140.164 
## GAMLSS-RS iteration 9: Global Deviance = 2140.002 
## GAMLSS-RS iteration 10: Global Deviance = 2139.893 
## GAMLSS-RS iteration 11: Global Deviance = 2139.816 
## 31-08-2020 17:46:05
## Converged: YES
## Iterations: 11
## 
## Coefficients:
## (Intercept)  25.9694147524852
##  log(abs(dist))  -1.73150502471814
##  b.trans_res 0.449221400670234
##  p.trans_res NA
##  sqrt(b.length)  -0.00490695196403016
##  sqrt(p.length)  -0.00602061166744378
## 31-08-2020 17:46:05
## Obtaining normalized randomized quantile residuals for the full dataset...
## A truncated family of distributions from NBI has been generated 
##  and saved under the names:  
##  dNBI.0tr pNBI.0tr qNBI.0tr rNBI.0tr NBI.0tr 
## The type of truncation is left 
##  and the truncation parameter is 0  
## 31-08-2020 17:46:05
## Subsampling 1000/9064 interactions for the null model regression...
## 31-08-2020 17:46:05
## Fitting with a maximum of 200 iterations...
## Using formula:
## N ~ log(abs(dist)) + b.trans_res  + p.trans_res + sqrt(b.length) + sqrt(p.length)
## GAMLSS-RS iteration 1: Global Deviance = 1570.279 
## GAMLSS-RS iteration 2: Global Deviance = 1561.284 
## GAMLSS-RS iteration 3: Global Deviance = 1557.102 
## GAMLSS-RS iteration 4: Global Deviance = 1554.65 
## GAMLSS-RS iteration 5: Global Deviance = 1553.038 
## GAMLSS-RS iteration 6: Global Deviance = 1551.89 
## GAMLSS-RS iteration 7: Global Deviance = 1551.041 
## GAMLSS-RS iteration 8: Global Deviance = 1550.384 
## GAMLSS-RS iteration 9: Global Deviance = 1549.867 
## GAMLSS-RS iteration 10: Global Deviance = 1549.446 
## GAMLSS-RS iteration 11: Global Deviance = 1549.098 
## GAMLSS-RS iteration 12: Global Deviance = 1548.804 
## GAMLSS-RS iteration 13: Global Deviance = 1548.555 
## GAMLSS-RS iteration 14: Global Deviance = 1548.344 
## GAMLSS-RS iteration 15: Global Deviance = 1548.16 
## GAMLSS-RS iteration 16: Global Deviance = 1548.008 
## GAMLSS-RS iteration 17: Global Deviance = 1547.874 
## GAMLSS-RS iteration 18: Global Deviance = 1547.755 
## GAMLSS-RS iteration 19: Global Deviance = 1547.65 
## GAMLSS-RS iteration 20: Global Deviance = 1547.557 
## 31-08-2020 17:46:06
## Converged: YES
## Iterations: 20
## 
## Coefficients:
## (Intercept)  65.7212776868882
##  log(abs(dist))  -4.35518100957048
##  b.trans_res 0.204486548712668
##  p.trans_res NA
##  sqrt(b.length)  -0.0035000713785154
##  sqrt(p.length)  -0.00379777515204353
## 31-08-2020 17:46:06
## Obtaining normalized randomized quantile residuals for the full dataset...</code></pre>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">models</span><span class="kw">[[</span><span class="fl">1</span>]]$<span class="no">fit</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
<pre><code>## ******************************************************************
##   Summary of the Randomised Quantile Residuals
##                            mean   =  -0.005840354 
##                        variance   =  0.9692239 
##                coef. of skewness  =  0.4036969 
##                coef. of kurtosis  =  3.731102 
## Filliben correlation coefficient  =  0.9925864 
## ******************************************************************</code></pre>
<p>Taking the observed readcounts and adjusting for the effects of biological and technical noise in the models gives us normalized readcounts: they quantify the extent to which the observed readcounts exceed those predicted under the null. In practice, the normalized readcounts are the randomized quantile residuals of each model. Note that the Q-Q plot shows a series of outliers: unexpectedly high adjusted read counts.</p>
<p>The adjusted readcounts for all putative interaction are extracted from the models below. They are tacked onto the interactions, which are all grouped together again using <code><a href="../reference/split_baits.html">split_baits()</a></code>. Note that the p-values calculated here mark the significance of the observed readcounts before local patterns across fragments are considered (such patterns will be considered later, using <code><a href="../reference/peaky.html">peaky()</a></code>).</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">residuals</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">models</span>, <span class="st">"[["</span>, <span class="st">"residuals"</span>)
<span class="no">bins</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span>(<span class="no">BI</span>$<span class="no">interactions</span>, <span class="no">BI</span>$<span class="no">interactions</span>$<span class="no">dist.bin</span>)
<span class="no">BTS</span> <span class="kw">=</span> <span class="fu"><a href="../reference/split_baits.html">split_baits</a></span>(<span class="no">bins</span>, <span class="no">residuals</span>)</pre></body></html></div>
<pre><code>## 31-08-2020 17:46:07
## Calculating p-values and performing bin-wise FDR-adjustments...</code></pre>
<p>Plotting the adjusted readcounts associated with a single bait (up to 1Mb around it) reveals that there is still an autocorrelated signal:</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">relevant_bait</span> <span class="kw">=</span> <span class="no">BTS</span>[<span class="no">baitID</span><span class="kw">==</span><span class="fl">618421</span>]
<span class="no">zoom</span> <span class="kw">=</span> <span class="no">relevant_bait</span>[<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="no">relevant_bait</span>$<span class="no">dist</span>)<span class="kw">&lt;</span><span class="fl">1e6</span>]
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw">x</span><span class="kw">=</span><span class="no">zoom</span>$<span class="no">dist</span>,
     <span class="kw">y</span><span class="kw">=</span><span class="no">zoom</span>$<span class="no">residual</span>,
     <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Distance from bait (bp)"</span>,
     <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Adjusted readcount"</span>,
     <span class="kw">main</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Bait"</span>,<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="no">zoom</span>$<span class="no">baitID</span>)))</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-5-1.png" width="672"> A central assumption of Peaky is that this signal stems from few direct contacts, regions above which the CHi-C signal peaks. The signal then decays amongst neighboring fragments, with which contacts are merely collateral.</p>
<p>##Joint analysis of neighboring fragments Next, Peaky identifies sets of direct contacts that explain the peaks in the adjusted readcounts. It takes a single bait and proposes direct contacts with several of its prey fragments simultaneously, at varying strengths.</p>
<p>To determine where direct contacts occur, Peaky must be told what a peak in the adjusted readcounts looks like: how quickly would the signal decay as we consider fragments further and further away from a fragment that is directly contacted? The steepness of the expected decay is set via the parameter <span class="math inline">\(\omega\)</span>:</p>
<p><span class="math display">\[\begin{equation}
y = \beta \exp{(-|\omega * d|)}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(y\)</span> is the contribution of a specific peak (direct contact) to the adjusted readcount we observe, <span class="math inline">\(\beta\)</span> represents peak height and <span class="math inline">\(d\)</span> the distance from the center of the peak in bp.</p>
<p>We can look at several isolated peaks to see what would be an appropriate choice of <span class="math inline">\(\omega\)</span>. For example, from the decay seen around the highest peak of the bait above, we can estimate that <span class="math inline">\(\omega \approx 10^{-5}\)</span>:</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="co">#Isolate the highest peak and adjusted readcounts within 40 kbp</span>
<span class="no">peak_center</span> <span class="kw">=</span> <span class="no">zoom</span>$<span class="no">dist</span>[<span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span>(<span class="no">zoom</span>$<span class="no">residual</span>)]
<span class="no">zoom</span>$<span class="no">distance_from_peak</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="no">zoom</span>$<span class="no">dist</span>-<span class="no">peak_center</span>)
<span class="no">single_peak</span> <span class="kw">=</span> <span class="no">zoom</span>[<span class="no">distance_from_peak</span><span class="kw">&lt;</span><span class="fl">4e5</span>,]

<span class="co">#Define the distance function and find the best fit for omega</span>
<span class="no">dist_exp</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">offset</span>, <span class="no">strength</span>, <span class="no">omega_power</span>){
  <span class="no">omega</span> <span class="kw">=</span> <span class="fl">10</span>^<span class="no">omega_power</span>
  <span class="no">strength</span> * <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(-(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="no">offset</span> * <span class="no">omega</span>)))
}

<span class="no">fit_omega</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/nls.html">nls</a></span>(<span class="no">residual</span>~<span class="fu">dist_exp</span>(<span class="no">distance_from_peak</span>,<span class="no">strength</span>,<span class="no">omega_power</span>),
    <span class="kw">data</span><span class="kw">=</span><span class="no">single_peak</span>,
    <span class="kw">start</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">strength</span><span class="kw">=</span><span class="fl">5</span>, <span class="kw">omega_power</span><span class="kw">=</span>-<span class="fl">3</span>))

{
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">single_peak</span>$<span class="no">distance_from_peak</span>, <span class="no">single_peak</span>$<span class="no">residual</span>,
     <span class="kw">main</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Decay of signal for an isolated peak\nEstimate of omega = 10^"</span>,
                <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coefficients</a></span>(<span class="no">fit_omega</span>)[<span class="st">"omega_power"</span>],<span class="fl">3</span>)),
     <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Distance from center of peak (bp)"</span>,
     <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Adjusted readcount"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(<span class="no">single_peak</span>$<span class="no">distance_from_peak</span>, <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted.values</a></span>(<span class="no">fit_omega</span>), <span class="kw">col</span><span class="kw">=</span><span class="st">"red"</span>, <span class="kw">lwd</span><span class="kw">=</span><span class="fl">3</span>)
}</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
<p>At this point, Peaky is ready to determine where peaks, or direct contacts, occur in the signal for the bait above. It does so iteratively, by proposing different sets (i.e. different models) of hypothetical peaks, and settling more often on more likely sets (through reversible-jump Markov chain Monte Carlo estimation). The number of sets proposed is controlled by the iterations parameter of <code><a href="../reference/peaky.html">peaky()</a></code>. It is recommended to increase the value until the results (e.g. MPPC, see below) are highly correlated between different runs of <code><a href="../reference/peaky.html">peaky()</a></code> (note that its output is not deterministic). Raw models and their likelihoods are stored in PKS, but these do not have to be inspected manually (although this is possible, e.g. to remove burn-in models or to construct trace plots). Instead, summary statistics can be calculated with <code><a href="../reference/interpret_peaky.html">interpret_peaky()</a></code>. For each fragment X, these are stored in the following columns:</p>
<ul>
<li>
<em>rjmcmc</em>: Proportion of sets featuring a peak at X</li>
<li>
<em>rjmcmc_pos</em>: Proporion of sets featuring an upward peak at X
<ul>
<li>referred to as the marginal posterior probability of contact (MPPC) in the main paper</li>
</ul>
</li>
<li>
<em>rjmcmc_neg</em>: Proportion of sets featuring a downward peak at X</li>
<li>
<em>rjmcmc_pos_present</em>: Proportion of peaks at X which were upward</li>
<li>
<em>rjmcmc_neg_present</em>: Proportion of peaks at X which were downward</li>
<li>
<em>beta</em>: Median contact strength at X across all sets (includes values of 0 whenever there was no peak at X)</li>
<li>
<em>beta_mean</em>: Mean contact strength at X across all sets (includes values of 0 whenever there was no peak at X)</li>
<li>
<em>beta_present</em>: Median contact strength at X whenever a peak was present</li>
<li>
<em>beta_mean_present</em>: Mean contact strength at X whenever a peak was present</li>
<li>
<em>predicted</em>: Reconstructed signal from all peaks, based on beta_mean</li>
<li>
<em>predicted_present</em>: Reconstructed signal from all peaks, based on beta_mean_present
<ul>
<li>can be undefined when beta_mean_present cannot be calculated, i.e. when a fragment has never been considered as a peak location</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="no">relevant_bait</span> <span class="kw">=</span> <span class="no">BTS</span>[<span class="no">baitID</span><span class="kw">==</span><span class="fl">618421</span>]
<span class="no">omega_power</span> <span class="kw">=</span> -<span class="fl">5</span>
<span class="no">PKS</span> <span class="kw">=</span> <span class="fu"><a href="../reference/peaky.html">peaky</a></span>(<span class="no">relevant_bait</span>, <span class="no">omega_power</span>, <span class="kw">iterations</span><span class="kw">=</span><span class="fl">1e6</span>)</pre></body></html></div>
<pre><code>## 31-08-2020 17:46:07
## Constructing distance matrix with omega=10^-5...
## 1e+06 iterations will be run...
## Setting user specified argument AlphaPriorMu 
## Setting user specified argument AlphaPriorSd 
## Setting user specified argument Alpha_Initial_Value 
## Setting user specified argument GaussianResidual_Initial_Value 
## Setting user specified argument GaussianResidualPrior_UnifArg1 
## Setting user specified argument GaussianResidualPrior_UnifArg2 
## Setting user specified argument GaussianResidualPriorFamily 
## Setting user specified argument Add_Move_Probability 
## Setting user specified argument Delete_Move_Probability 
## Setting user specified argument Swap_Move_Probability 
## 0 observations deleted due to missingnessWriting data into an input file for BGLiMS...
## Data written in 0 hrs 0 mins and 48 seconds.
## Calling BGLiMS Java algorithm with command: 
## java -jar "/home/cq/R/x86_64-pc-linux-gnu-library/3.6/R2BGLiMS/BGLiMS/BGLiMS.jar" "/tmp/RtmpnnnBwV/file73384cebda67_Aug31174608_Arguments.txt" "/tmp/RtmpnnnBwV/file7338516d6e39_Aug31174608_Data.txt" "/tmp/RtmpnnnBwV/file73386d8c38c3_Aug31174608_Results.txt" 1000000 0 100 100000 509259 1 1 0 -1 1 1 1 1707 
## BGLiMS Java computation finished in 0 hrs 4 mins and 57 seconds.
## Reading BGLiMS posterior output...
## Posterior output processed in 0 hrs 0 mins and 10 seconds.
## Finished.</code></pre>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">P</span> <span class="kw">=</span> <span class="fu"><a href="../reference/interpret_peaky.html">interpret_peaky</a></span>(<span class="no">relevant_bait</span>, <span class="no">PKS</span>, <span class="no">omega_power</span>)</pre></body></html></div>
<pre><code>## 31-08-2020 17:52:04
## Calculating alphas...
## 31-08-2020 17:52:04
## Calculating posteriors...
## 31-08-2020 17:52:07
## Calculating betas means and medians...
## 31-08-2020 17:52:08
## Constructing distance matrix with omega=10^-5...
## Finding RJMCMC predictions based on mean betas...
## 31-08-2020 17:52:09
## Wrapping up...</code></pre>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mfrow</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">1</span>))
<span class="no">zoom</span> <span class="kw">=</span> <span class="no">P</span>[<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="no">P</span>$<span class="no">dist</span>)<span class="kw">&lt;</span><span class="fl">1e6</span>]
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw">x</span><span class="kw">=</span><span class="no">zoom</span>$<span class="no">dist</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Distance from bait (bp)"</span>,
     <span class="kw">y</span><span class="kw">=</span><span class="no">zoom</span>$<span class="no">residual</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Adjusted readcount"</span>)

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw">x</span><span class="kw">=</span><span class="no">zoom</span>$<span class="no">dist</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Distance from bait (bp)"</span>,
     <span class="kw">y</span><span class="kw">=</span><span class="no">zoom</span>$<span class="no">beta_mean</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Mean contact strength"</span>,
     <span class="kw">col</span><span class="kw">=</span><span class="st">"green"</span>)

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw">x</span><span class="kw">=</span><span class="no">zoom</span>$<span class="no">dist</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Distance from bait (bp)"</span>,
     <span class="kw">y</span><span class="kw">=</span><span class="no">zoom</span>$<span class="no">rjmcmc_pos</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"MPPC"</span>,
     <span class="kw">col</span><span class="kw">=</span><span class="st">"blue"</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-7-1.png" width="672"> While many fragments originally had high (adjusted) readcounts, the peaks in the CHi-C signal can be explained by only 3-4 direct contacts, and MPPC values jump up where these occur.</p>
<p>##Filesystem version</p>
<p>To make the software more convenient for use on a cluster, Peaky has wrapper functions that interact directly with the filesystem. These wrappers generally take integer arguments specifying which inputs (out of some directory) to work with, and save results directly to disk.</p>
<p>The workflow is similar to (and arguably simpler than) that of the interactive version, and allows for parallelization at the following computationally intensive steps:</p>
<ul>
<li>Removing initial noise (going from raw readcounts to adjusted readcounts) with <code>model_bin_fs</code>
</li>
<li>Separating direct from collateral contacts with <code><a href="../reference/peaky_fs.html">peaky_fs()</a></code>
</li>
</ul>
<p>These two functions are demonstrated within for-loops in the example below, but would normally be run in parallel (e.g. via a scheduler).</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">base</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>,<span class="kw">package</span><span class="kw">=</span><span class="st">"peaky"</span>)
<span class="no">interactions_file</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">base</span>,<span class="st">"/counts.tsv"</span>)
<span class="no">bins_dir</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">base</span>,<span class="st">"/bins"</span>)
<span class="no">fragments_file</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">base</span>,<span class="st">"/fragments.bed"</span>)

<span class="fu"><a href="../reference/bin_interactions_fs.html">bin_interactions_fs</a></span>(<span class="no">interactions_file</span>, <span class="no">fragments_file</span>, <span class="kw">output_dir</span><span class="kw">=</span><span class="no">bins_dir</span>)

<span class="no">fits_dir</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">base</span>,<span class="st">"/fits"</span>)

<span class="kw">for</span>(<span class="no">bin_index</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fl">5</span>){
  <span class="fu"><a href="../reference/model_bin_fs.html">model_bin_fs</a></span>(<span class="no">bins_dir</span>,<span class="no">bin_index</span>,<span class="kw">output_dir</span><span class="kw">=</span><span class="no">fits_dir</span>,<span class="kw">subsample_size</span><span class="kw">=</span><span class="fl">1000</span>)
}

<span class="no">baits_dir</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">base</span>,<span class="st">"/baits"</span>)

<span class="fu"><a href="../reference/split_baits_fs.html">split_baits_fs</a></span>(<span class="no">bins_dir</span>,<span class="kw">residuals_dir</span> <span class="kw">=</span> <span class="no">fits_dir</span>, <span class="kw">indices</span><span class="kw">=</span><span class="fl">1</span>:<span class="fl">5</span>, <span class="kw">output_dir</span> <span class="kw">=</span> <span class="no">baits_dir</span>)

<span class="no">baitlist</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">baits_dir</span>,<span class="st">"/baitlist.txt"</span>)
<span class="no">rjmcmc_dir</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">base</span>,<span class="st">"/rjmcmc"</span>)
<span class="no">omega_power</span> <span class="kw">=</span> -<span class="fl">5</span>

<span class="kw">for</span>(<span class="no">i</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fl">1</span>){
 <span class="fu"><a href="../reference/peaky_fs.html">peaky_fs</a></span>(<span class="no">baitlist</span>,<span class="no">i</span>,<span class="kw">output_dir</span><span class="kw">=</span><span class="no">rjmcmc_dir</span>,<span class="kw">omega_power</span><span class="kw">=</span><span class="no">omega_power</span>)
}

<span class="fu"><a href="../reference/rjmcmc_list.html">rjmcmc_list</a></span>(<span class="no">rjmcmc_dir</span>)

<span class="no">rjmcmclist</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">rjmcmc_dir</span>,<span class="st">"/rjmcmclist.txt"</span>)
<span class="no">baits_rjmcmc_dir</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">base</span>,<span class="st">"/baits_rjmcmc"</span>)
<span class="fu"><a href="../reference/interpret_peaky_fs.html">interpret_peaky_fs</a></span>(<span class="no">rjmcmclist</span>,<span class="fl">1</span>,<span class="no">baits_dir</span>,<span class="no">baits_rjmcmc_dir</span>,<span class="no">omega_power</span>)</pre></body></html></div>
<p>After running the code above, results should be neatly saved in the package’s directory.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Chris Eijsbouts, Chris Wallace.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
